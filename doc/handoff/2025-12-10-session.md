# 引き継ぎファイル - 2025年12月10日セッション

## セッション概要

**日付**: 2025年12月10日
**主なトピック**:
- スーパーアドミン機能の実装完了と Git プッシュ
- 新規顧客へのアプリ提供方法の整理
- .env.example の作成
- モバイルアプリ開発の方針決定

## 完了したタスク

### 1. スーパーアドミン機能の実装完了

前回のセッションから継続していたスーパーアドミン機能を完成させ、Git にプッシュしました。

#### 実装内容

**データベース変更**:
- `is_super_admin` カラムを users テーブルに追加
- Prisma スキーマに `isSuperAdmin` フィールドを追加
- `@map("is_super_admin")` でスネークケース/キャメルケースを変換

**初回セットアップ機能**:
- `/setup` ページの作成（管理者が0人の場合のみアクセス可能）
- `POST /api/setup` API（スーパーアドミン作成）
- `GET /api/setup/check` API（セットアップ可否チェック）
- 作成後は自動的にログイン状態になる

**スーパーアドミン保護機能**:
- 管理者管理UI に黄色の「スーパー」バッジを表示
- スーパーアドミンは「変更不可」と表示（権限変更ボタン非表示）
- API レベルでスーパーアドミンの降格を防止

**認証の改善**:
- 管理者ログインページで AuthContext の `login()` 関数を使用
- Cookie（サーバー側）と Context state（クライアント側）の同期問題を解決

**UI改善**:
- 入力フィールドのテキスト色を修正（`text-gray-900` を追加）

**ドキュメント更新**:
- README.md: スーパーアドミン機能の説明を追加
- 要件定義書.md: 初回セットアップ、スーパーアドミン保護、データベーススキーマ、セキュリティ要件を更新
- 変更履歴に v2.5 を追加

#### Git コミット情報

- **コミット**: fcf2a82
- **メッセージ**: "feat: スーパーアドミン機能の追加"
- **プッシュ先**: origin/main

### 2. 新規顧客デプロイガイドの作成

新規顧客へのアプリ提供方法を体系的にまとめたドキュメントを作成しました。

#### ファイル

`doc/learning/new-customer-deployment-guide.md`

#### 主な内容

1. **基本概念**
   - マスターリポジトリとクローンの関係（**クラスとインスタンスの例え**で説明）
   - Git Clone vs ZIP ダウンロードの比較
   - npm install が必要な理由

2. **詳細な手順（8ステップ）**
   - Git Clone でのクローン作成
   - 依存パッケージのインストール
   - 環境変数の設定（セキュリティ重要事項含む）
   - データベースのセットアップ
   - ローカルテスト
   - Git リポジトリの管理
   - Vercel へのデプロイ
   - 初回セットアップ

3. **マスターの更新を顧客に反映する方法**

4. **チェックリスト**
   - セキュリティ
   - データベース
   - デプロイ
   - 動作確認

5. **よくある問題と解決方法**

6. **セキュリティのベストプラクティス**

#### 重要なポイント

**プログラミングの概念との対応**:
```
マスターリポジトリ = クラス定義
顧客用クローン = インスタンス
git clone = new ClassName()
.env = コンストラクタ引数
```

この例えにより、ユーザーが Git の運用を深く理解できました。

### 3. .env.example の作成

新規顧客へのセットアップを簡素化するため、環境変数のテンプレートファイルを作成しました。

#### 実装内容

**ファイル**: `.env.example`

**内容**:
- DATABASE_URL のテンプレート（プレースホルダー付き）
- JWT_SECRET の生成方法
- NEXT_PUBLIC_SUPABASE_URL のテンプレート
- NEXT_PUBLIC_SUPABASE_ANON_KEY のテンプレート
- 詳細なコメントとセットアップ手順
- セキュリティの注意事項

**.gitignore の修正**:
```gitignore
.env*              # すべての .env ファイルを除外
!.env.example      # .env.example だけ Git に含める
```

**動作確認済み**:
- `.env` は Git に含まれない（機密情報を保護）
- `.env.example` は Git に含まれる（テンプレートとして共有）

#### Git コミット情報

- **コミット**: 39f5602
- **メッセージ**: "docs: 環境変数テンプレートと新規顧客デプロイガイドを追加"
- **プッシュ先**: origin/main

#### 使用方法

新規顧客へのセットアップ時：

```bash
# 1. クローン
git clone https://github.com/Ishikawa-Yutaka/daily-report.git customer-a

# 2. .env.example をコピー
cd customer-a
cp .env.example .env

# 3. .env を編集（テンプレートがあるので簡単！）
nano .env

# 4. セットアップ
npm install
npx prisma generate
npm run dev
```

## 重要な学習内容

### 1. Git Clone を使った新規顧客への提供方法

#### なぜ Git Clone なのか

| 方法 | メリット | デメリット |
|---|---|---|
| **Git Clone（推奨）** | ・Git履歴が保持される<br>・`git pull` で簡単にアップデート<br>・マージが自動<br>・Vercel自動デプロイ対応 | ・Gitが必要 |
| **ZIP ダウンロード** | ・Git不要<br>・ワンクリック | ・Git履歴が消える<br>・アップデートが手動<br>・マージが困難<br>・バージョン管理不可 |

#### マスターリポジトリとクローンの関係

**プログラミングの概念との対応**:

```typescript
// クラス定義（マスターリポジトリ）
class DailyReportApp {
  constructor(databaseUrl, jwtSecret, supabaseUrl) {
    this.databaseUrl = databaseUrl
    this.jwtSecret = jwtSecret
    this.supabaseUrl = supabaseUrl
  }

  createReport() { ... }  // 共通機能
  editReport() { ... }
  deleteReport() { ... }
}

// インスタンス化（顧客用クローン）
const customerA = new DailyReportApp(
  "postgresql://...customer-a-db...",
  "customer-a-secret-key",
  "https://project-a.supabase.co"
)

const customerB = new DailyReportApp(
  "postgresql://...customer-b-db...",
  "customer-b-secret-key",
  "https://project-b.supabase.co"
)
```

**対応表**:

| プログラミング | Git |
|---|---|
| クラス定義 | マスターリポジトリ |
| インスタンス | 顧客用クローン |
| `new ClassName()` | `git clone` |
| インスタンス変数 | `.env`, データベース |
| メソッド | ソースコード |
| クラスにメソッド追加 | マスターにコミット |
| 既存インスタンスも使える | `git pull` |

この例えにより、ユーザーが深く理解できました。

### 2. npm install が必要な理由

#### なぜ node_modules をコピーしないのか

- `node_modules` は巨大（500MB〜1GB）
- コピーに時間がかかる
- ストレージを無駄に消費
- `.gitignore` で除外されている

#### パッケージの重複は発生しない

- `package.json` は設計図（2KB）
- `npm install` が設計図を元にダウンロード
- 各プロジェクトで独立した `node_modules/` を生成
- npm キャッシュにより、2回目以降は高速

#### OS/アーキテクチャ依存のバイナリ

一部のパッケージ（bcrypt, prisma）は環境依存のネイティブコードを含むため、各環境で `npm install` が必要。

### 3. .env と .env.example の違い

| ファイル | 用途 | Git管理 | 内容 |
|---|---|---|---|
| **.env** | 実際に使用する環境変数 | ❌ 含めない | 本物の値（パスワード、シークレットキー） |
| **.env.example** | テンプレート・ドキュメント | ✅ 含める | ダミーの値、説明、例 |

#### .env.example を使用するタイミング

1. 新規顧客にアプリを提供する時
2. 新しい開発者がプロジェクトに参加する時
3. 別の環境（開発、ステージング、本番）をセットアップする時
4. CI/CD の環境変数を設定する時

#### .env.local との違い

Next.js では複数の環境変数ファイルをサポート：

| ファイル | 優先度 | 用途 | Git管理 |
|---|---|---|---|
| `.env` | 低 | 全環境共通のデフォルト値 | ✅ 含めることもある |
| `.env.local` | 高 | ローカル開発専用の値（最優先） | ❌ 含めない |
| `.env.development` | 中 | 開発環境専用 | ✅ 含めることもある |
| `.env.production` | 中 | 本番環境専用 | ❌ 含めない |

現在のプロジェクトでは `.env` のみを使用（シンプル）。

### 4. セキュリティのベストプラクティス

#### 絶対に守るべきこと

1. **顧客ごとに独立したデータベース**
   - データベースを共有しない
   - 各顧客専用のSupabaseプロジェクトを作成

2. **顧客ごとに異なる JWT_SECRET**
   - 同じシークレットは絶対に使わない
   - 最低32文字以上のランダムな文字列
   - 生成方法: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

3. **.env ファイルを Git にコミットしない**
   - `.gitignore` に `.env` が含まれているか確認
   - GitHub に誤ってプッシュしていないか確認

## モバイルアプリ開発の方針

### 現状の確認

既に React Native (Expo) のモバイルアプリが `mobile/` ディレクトリに存在：

**実装済み**:
- HomeScreen（日報一覧）
- NewReportScreen（新規日報作成）
- ReportDetailScreen（日報詳細）

**未実装**:
- 認証画面（ログイン・サインアップ）
- 管理者機能
- 検索・フィルター機能
- Web版の最新機能（スーパーアドミン、期間フィルターなど）

### 開発方針の決定

ユーザーの戦略的判断：

**日報アプリ + 出退勤アプリの連携を考えると、ネイティブアプリが必須**

#### 連携で実現する機能

1. **出勤打刻 → 自動で日報作成開始**
2. **退勤打刻 → 日報完成を促す**
3. **位置情報の活用** - 出勤場所の記録
4. **プッシュ通知** - 出勤・退勤リマインダー、日報未提出通知
5. **オフライン対応** - ネットワークがない場所でも打刻

#### ネイティブアプリが必須の理由

| 要件 | Web版 | ネイティブアプリ |
|---|---|---|
| 位置情報取得 | △ ブラウザ経由（制限あり） | ✅ バックグラウンドでも取得可能 |
| プッシュ通知 | ❌ ほぼ不可（iOS制限） | ✅ 完全対応 |
| オフライン対応 | △ 限定的 | ✅ 完全対応 |
| バックグラウンド処理 | ❌ 不可 | ✅ 自動打刻も可能 |

### React Native 開発の優先順位

#### フェーズ1: 日報アプリの基本機能を完成（優先度：最高）

1. 認証機能（ログイン・サインアップ）
2. 日報機能の完成（Web版と同じ機能）
3. 基本的なオフライン対応

#### フェーズ2: 出退勤アプリとの連携（優先度：高）

1. 共通の認証基盤（同じJWTトークン）
2. データ連携（出退勤データから稼働時間を自動計算）
3. 位置情報の連携

#### フェーズ3: ネイティブ機能の実装（優先度：中）

1. プッシュ通知（Expo Notifications）
2. 位置情報（Expo Location）
3. オフライン同期（SQLite）

#### フェーズ4: アプリストア公開（優先度：低）

1. iOS App Store
2. Google Play Store

## 次のタスク候補

### 優先度：最高

1. **React Native の現状確認と計画立案**
   - `mobile/` の詳細な状況確認
   - 実装すべき機能のリストアップ
   - 開発計画の策定

2. **React Native 認証機能の実装**
   - ログイン画面
   - サインアップ画面
   - JWT トークン管理（AsyncStorage）

### 優先度：高

3. **Web版のデプロイ（並行作業として）**
   - Vercel にデプロイ
   - スマホブラウザで動作確認
   - パフォーマンステスト

4. **出退勤アプリとの連携設計**
   - 両アプリのデータ構造設計
   - 連携方法の検討

### 優先度：中

5. **Web版の機能拡張**
   - PDF/Excel 出力機能
   - 稼働時間フィルター機能
   - グラフ・統計機能の強化

## ファイル構成

```
web/
├── .env                          # 開発用の環境変数（.gitignore）
├── .env.example                  # 環境変数のテンプレート（Git に含める）NEW!
├── .gitignore                    # .env.example を含めるように修正
├── app/
│   ├── setup/                    # 初回セットアップ画面 NEW!
│   │   └── page.tsx
│   ├── api/
│   │   ├── setup/                # セットアップAPI NEW!
│   │   │   ├── route.ts          # POST /api/setup
│   │   │   └── check/
│   │   │       └── route.ts      # GET /api/setup/check
│   │   └── admin/
│   │       ├── login/page.tsx    # AuthContext統合 UPDATED!
│   │       ├── users/page.tsx    # スーパーアドミンバッジ UPDATED!
│   │       └── logs/page.tsx     # テキスト色修正 UPDATED!
├── prisma/
│   ├── schema.prisma             # isSuperAdmin フィールド追加 UPDATED!
│   └── migrations/
│       └── add_is_super_admin.sql # マイグレーションファイル NEW!
├── doc/
│   ├── handoff/
│   │   ├── 2025-12-05-session.md
│   │   └── 2025-12-10-session.md # この引き継ぎファイル NEW!
│   └── learning/
│       └── new-customer-deployment-guide.md # デプロイガイド NEW!
├── README.md                     # スーパーアドミン機能追加 UPDATED!
├── MIGRATION.md                  # v4 マイグレーション追加 UPDATED!
└── 要件定義書.md                # v2.5 に更新 UPDATED!
```

## Git コミット履歴

```
39f5602 docs: 環境変数テンプレートと新規顧客デプロイガイドを追加
fcf2a82 feat: スーパーアドミン機能の追加
a971598 feat: 管理者側に検索・フィルター機能を追加 & 期間計算関数を共通化
e5df481 feat: 期間フィルター機能を追加（社員側）
```

## 未解決の課題・検討事項

### 1. Web版のデプロイ

まだ本番環境（Vercel）にデプロイしていません。

**必要な作業**:
- Vercel CLI のセットアップ
- 環境変数の設定
- 本番デプロイ
- 動作確認

### 2. React Native の詳細な状況確認

`mobile/` ディレクトリの現状を詳しく確認し、実装計画を立てる必要があります。

### 3. 出退勤アプリとの連携設計

両アプリのデータ構造と連携方法を具体的に設計する必要があります。

## 重要な注意点

### セキュリティ

1. **JWT_SECRET は顧客ごとに必ず異なる値を使用**
2. **DATABASE_URL は顧客ごとに完全に独立**
3. **.env ファイルは絶対にGitにコミットしない**

### 顧客への提供時

1. 各顧客専用のSupabaseプロジェクトを作成
2. 各顧客専用のJWT_SECRETを生成
3. データベースを顧客間で共有しないこと

### Vercelデプロイ時

1. Vercelダッシュボードで環境変数を設定
2. ローカルの .env とは別に管理
3. Production, Preview, Development すべてにチェック

## 次回セッションへの引き継ぎ

### 優先的に取り組むべきタスク

1. **React Native の現状確認と計画立案**
   - ユーザーの戦略（日報アプリ + 出退勤アプリの連携）を踏まえて
   - ネイティブアプリの開発を優先

2. **React Native 認証機能の実装**
   - Web版と同じJWT認証
   - AsyncStorage でトークン管理

3. **Web版のデプロイ（並行作業として）**
   - 顧客デモ用

### 保留中のタスク

- PDF/Excel 出力機能
- 稼働時間フィルター機能
- グラフ・統計機能の強化
- メール通知機能

## 参考ドキュメント

- `doc/learning/new-customer-deployment-guide.md` - 新規顧客へのデプロイ手順
- `.env.example` - 環境変数のテンプレート
- `MIGRATION.md` - データベースマイグレーション手順
- `README.md` - プロジェクト全体のドキュメント
- `要件定義書.md` - 要件定義（v2.5）

## セッション終了時の状態

- ✅ スーパーアドミン機能は完全に実装済み
- ✅ .env.example は作成済み
- ✅ 新規顧客デプロイガイドは作成済み
- ✅ すべての変更は Git にコミット＆プッシュ済み
- 📋 モバイルアプリ開発の方針は決定済み
- ⏳ React Native の詳細確認と実装はこれから
- ⏳ Web版のデプロイはまだ未実施
