# 日報管理システム 要件定義書

## 1. システム概要

### 1.1 目的
社員が日々の業務内容を記録し、管理者が全社員の業務状況を把握できるWebベースの日報管理システムを構築する。

### 1.2 対象ユーザー
- **一般ユーザー（社員）**: 自身の日報を作成・編集・閲覧
- **管理者**: 全社員の日報閲覧、社員権限管理、操作ログ確認

### 1.3 システムの特徴
- JWT認証による安全なユーザー管理
- 動的な活動セクション（プロジェクト別に複数記録可能）
- 管理者による権限管理機能
- 全管理者操作のログ記録

## 2. 機能要件

### 2.1 認証機能

#### 2.1.1 一般ユーザー認証
- **サインアップ**
  - 入力項目: 社員番号、社員名、パスワード
  - 社員番号は一意である必要がある
  - パスワードはbcryptでハッシュ化して保存
  - デフォルトで`USER`ロールを付与

- **ログイン**
  - 入力項目: 社員番号、パスワード
  - JWTトークンを発行（有効期限7日間）
  - トークンはhttpOnly Cookieに保存

- **ログアウト**
  - Cookieからトークンを削除

#### 2.1.2 管理者認証
- **管理者専用ログイン画面** (`/admin/login`)
  - 一般ログインと同じ認証フローを使用
  - ログイン後に管理者権限をチェック
  - 管理者でない場合はログアウト
  - ログイン成功時に操作ログを記録

### 2.2 日報機能（一般ユーザー）

#### 2.2.1 日報作成
- **入力項目**
  - 日付（デフォルト: 今日）
  - 本日の目標（テキストエリア）
  - 活動セクション（動的に追加・削除可能）
    - プロジェクト/カテゴリー
    - 活動内容
    - 稼働時間
      - 開始時刻（時分入力）
      - 終了時刻（時分入力）
      - 作業時間（自動計算）
    - 課題
  - 改善点・気づき（テキストエリア）
  - 嬉しかったこと・感動したこと（テキストエリア）
  - これからのタスク（テキストエリア）

- **制約事項**
  - すべての項目が必須
  - 活動セクションは最低1つ必要
  - 自動的にログインユーザーのIDが紐付けられる

#### 2.2.2 日報一覧表示
- ログインユーザーの日報のみ表示
- 日付の降順で表示
- 各日報に以下を表示:
  - 日付
  - 活動数
  - 合計稼働時間
  - 詳細リンク

#### 2.2.3 日報詳細表示
- 自分の日報のみ閲覧可能
- 全項目を表示
- 活動セクションは順番に表示

#### 2.2.4 日報編集
- 自分の日報のみ編集可能
- 全項目編集可能
- 活動セクションの追加・削除可能
- 日報詳細ページから編集モードに切り替え可能
- 編集フォームで全項目を更新
- キャンセルボタンで閲覧モードに戻る

#### 2.2.5 日報削除
- 自分の日報のみ削除可能
- 削除時に確認ダイアログ表示
- 関連する活動も自動削除（カスケード削除）

### 2.3 管理画面機能

#### 2.3.1 管理者ダッシュボード (`/admin`)
- **統計情報表示**
  - 社員数
  - 日報総数
  - 総稼働時間

- **日報一覧**
  - 全社員の日報を表示
  - 日付降順でソート
  - 各日報に以下を表示:
    - 日付
    - 社員名・社員番号
    - 活動数
    - 合計稼働時間
    - 詳細リンク

- **フィルター機能**
  - 社員で絞り込み
  - 開始日・終了日で期間指定
  - フィルター適用・リセットボタン

- **ナビゲーション**
  - 日報一覧へのリンク
  - 社員管理へのリンク
  - 操作ログへのリンク

#### 2.3.2 社員管理 (`/admin/users`)
- **社員一覧表示**
  - 全社員を表示
  - 社員番号の昇順でソート
  - 各社員に以下を表示:
    - 社員番号
    - 氏名
    - 権限（USER / ADMIN）
    - 日報数
    - 登録日
    - 権限変更ボタン

- **権限変更機能**
  - 「管理者に昇格」ボタン（一般ユーザーの場合）
  - 「一般ユーザーに降格」ボタン（管理者の場合）
  - 変更前に確認ダイアログ表示
  - 変更後に成功メッセージ表示
  - 操作を自動的にログに記録

- **注意事項表示**
  - 管理者権限について説明
  - 権限変更がログに記録されることを明示

#### 2.3.3 操作ログ (`/admin/logs`)
- **ログ一覧表示**
  - 全管理者の操作履歴を表示
  - 日時の降順でソート（最新100件）
  - 各ログに以下を表示:
    - 日時（年月日 時分秒）
    - 管理者名・社員番号
    - 操作タイプ（バッジ表示）
    - 詳細情報
    - IPアドレス

- **フィルター機能**
  - 操作タイプで絞り込み
  - 選択肢: すべて、ログイン、ログアウト、日報閲覧、日報フィルター、権限変更、社員一覧閲覧、ログ閲覧

- **操作タイプ**
  - `LOGIN`: 管理画面ログイン
  - `LOGOUT`: 管理画面ログアウト
  - `VIEW_REPORT`: 日報詳細閲覧
  - `FILTER_REPORTS`: 日報フィルター使用
  - `CHANGE_USER_ROLE`: 社員権限変更
  - `VIEW_USERS`: 社員一覧閲覧
  - `VIEW_LOGS`: 操作ログ閲覧

#### 2.3.4 日報詳細（管理者用） (`/admin/reports/[id]`)
- 全社員の日報を閲覧可能
- 社員情報を表示（名前、社員番号）
- すべての日報項目を表示
- 編集・削除機能は提供しない（閲覧のみ）

### 2.4 権限管理

#### 2.4.1 初回管理者の作成
- SQLで直接データベースに作成
- `role`を`ADMIN`に設定

#### 2.4.2 管理者権限の付与
- 既存の管理者が社員管理画面で実行
- ボタンクリックで昇格・降格
- 操作は自動的にログに記録

#### 2.4.3 権限の種類
- `USER`: 一般ユーザー（自分の日報のみ操作可能）
- `ADMIN`: 管理者（全日報閲覧、権限管理、ログ閲覧）

## 3. 非機能要件

### 3.1 セキュリティ
- パスワードはbcryptでハッシュ化（salt rounds: 10）
- JWTトークンの有効期限: 7日間
- トークンはhttpOnly Cookieに保存（XSS対策）
- sameSite属性: lax（CSRF対策）
- 管理者APIは全てADMIN権限チェック
- 管理者の操作は全てログに記録
- IPアドレスをログに記録

### 3.2 パフォーマンス
- データベースにインデックスを設定
  - users.employee_number
  - users.role
  - daily_reports.user_id
  - activities.report_id
  - admin_logs.admin_id
  - admin_logs.action_type
  - admin_logs.created_at

### 3.3 ユーザビリティ
- レスポンシブデザイン（モバイル対応）
- 読み込み中のローディング表示
- エラーメッセージの適切な表示
- 確認ダイアログの実装（削除、権限変更）
- フィードバックメッセージの表示（成功、エラー）

### 3.4 保守性
- TypeScriptによる型安全性
- コンポーネントの再利用性
- API RouteとUIの分離
- Prismaによるデータベース管理

## 4. データベース設計

### 4.1 ER図

```
┌─────────────┐
│    User     │
├─────────────┤
│ id          │──┐
│ employeeNum │  │
│ employeeName│  │
│ passwordHash│  │
│ role        │  │
│ createdAt   │  │
│ updatedAt   │  │
└─────────────┘  │
       │         │
       │ 1       │ 1
       │         │
       │ *       │ *
       ↓         ↓
┌─────────────┐ ┌───────────────┐
│ DailyReport │ │   AdminLog    │
├─────────────┤ ├───────────────┤
│ id          │ │ id            │
│ date        │ │ adminId       │
│ quarterly   │ │ actionType    │
│ improvements│ │ targetUserId  │
│ happyMoments│ │ targetReportId│
│ futureTasks │ │ details       │
│ userId      │ │ ipAddress     │
│ createdAt   │ │ createdAt     │
│ updatedAt   │ └───────────────┘
└─────────────┘
       │
       │ 1
       │
       │ *
       ↓
┌─────────────┐
│  Activity   │
├─────────────┤
│ id          │
│ reportId    │
│ projCategory│
│ content     │
│ workingHours│
│ issues      │
│ order       │
│ createdAt   │
│ updatedAt   │
└─────────────┘
```

### 4.2 テーブル定義

#### User（ユーザー）
| カラム名        | 型      | 制約                  | 説明                  |
|-----------------|---------|----------------------|----------------------|
| id              | UUID    | PK                   | ユーザーID            |
| employeeNumber  | VARCHAR | UNIQUE, NOT NULL     | 社員番号              |
| employeeName    | VARCHAR | NOT NULL             | 社員名                |
| passwordHash    | VARCHAR | NOT NULL             | パスワードハッシュ     |
| role            | ENUM    | NOT NULL, DEFAULT USER | 権限（USER/ADMIN）   |
| createdAt       | TIMESTAMP | NOT NULL           | 作成日時              |
| updatedAt       | TIMESTAMP | NOT NULL           | 更新日時              |

**インデックス**:
- `employeeNumber`
- `role`

#### DailyReport（日報）
| カラム名        | 型      | 制約                  | 説明                  |
|-----------------|---------|----------------------|----------------------|
| id              | UUID    | PK                   | 日報ID                |
| date            | DATE    | NOT NULL             | 日付                  |
| dailyGoal       | TEXT    | NOT NULL             | 本日の目標            |
| improvements    | TEXT    | NOT NULL             | 改善点・気づき        |
| happyMoments    | TEXT    | NOT NULL             | 嬉しかったこと        |
| futureTasks     | TEXT    | NOT NULL             | これからのタスク      |
| userId          | UUID    | FK, NOT NULL         | ユーザーID            |
| createdAt       | TIMESTAMP | NOT NULL           | 作成日時              |
| updatedAt       | TIMESTAMP | NOT NULL           | 更新日時              |

**外部キー**:
- `userId` → `User.id` (ON DELETE CASCADE)

**インデックス**:
- `userId`

#### Activity（活動）
| カラム名        | 型      | 制約                  | 説明                  |
|-----------------|---------|----------------------|----------------------|
| id              | UUID    | PK                   | 活動ID                |
| reportId        | UUID    | FK, NOT NULL         | 日報ID                |
| projectCategory | VARCHAR | NOT NULL             | プロジェクト/カテゴリー |
| content         | TEXT    | NOT NULL             | 活動内容              |
| workingHours    | FLOAT   | NOT NULL             | 稼働時間（時間）      |
| startTime       | VARCHAR | NULL                 | 開始時刻（HH:mm）     |
| endTime         | VARCHAR | NULL                 | 終了時刻（HH:mm）     |
| issues          | TEXT    | NOT NULL             | 課題                  |
| order           | INTEGER | NOT NULL, DEFAULT 0  | 表示順                |
| createdAt       | TIMESTAMP | NOT NULL           | 作成日時              |
| updatedAt       | TIMESTAMP | NOT NULL           | 更新日時              |

**外部キー**:
- `reportId` → `DailyReport.id` (ON DELETE CASCADE)

**インデックス**:
- `reportId`

#### AdminLog（管理者操作ログ）
| カラム名        | 型      | 制約                  | 説明                  |
|-----------------|---------|----------------------|----------------------|
| id              | UUID    | PK                   | ログID                |
| adminId         | UUID    | FK, NOT NULL         | 管理者ID              |
| actionType      | ENUM    | NOT NULL             | 操作タイプ            |
| targetUserId    | UUID    | NULL                 | 対象ユーザーID        |
| targetReportId  | UUID    | NULL                 | 対象日報ID            |
| details         | TEXT    | NULL                 | 詳細情報              |
| ipAddress       | VARCHAR | NULL                 | IPアドレス            |
| createdAt       | TIMESTAMP | NOT NULL           | 作成日時              |

**外部キー**:
- `adminId` → `User.id` (ON DELETE CASCADE)

**インデックス**:
- `adminId`
- `actionType`
- `createdAt`

**ActionType ENUM値**:
- `LOGIN`
- `LOGOUT`
- `VIEW_REPORT`
- `FILTER_REPORTS`
- `CHANGE_USER_ROLE`
- `VIEW_USERS`
- `VIEW_LOGS`

## 5. API設計

### 5.1 認証API

#### POST /api/auth/signup
ユーザー登録

**リクエスト**:
```json
{
  "employeeNumber": "EMP001",
  "employeeName": "山田太郎",
  "password": "password123"
}
```

**レスポンス**:
```json
{
  "user": {
    "id": "uuid",
    "employeeNumber": "EMP001",
    "employeeName": "山田太郎",
    "role": "USER"
  },
  "token": "jwt-token"
}
```

#### POST /api/auth/login
ログイン

**リクエスト**:
```json
{
  "employeeNumber": "EMP001",
  "password": "password123"
}
```

**レスポンス**:
```json
{
  "user": {
    "id": "uuid",
    "employeeNumber": "EMP001",
    "employeeName": "山田太郎",
    "role": "USER"
  },
  "token": "jwt-token"
}
```

#### POST /api/auth/logout
ログアウト

**レスポンス**:
```json
{
  "message": "ログアウトしました"
}
```

#### GET /api/auth/me
現在のユーザー情報取得

**レスポンス**:
```json
{
  "user": {
    "id": "uuid",
    "employeeNumber": "EMP001",
    "employeeName": "山田太郎",
    "role": "USER"
  }
}
```

### 5.2 日報API

#### GET /api/reports
日報一覧取得（ログインユーザーのみ）

**レスポンス**:
```json
[
  {
    "id": "uuid",
    "date": "2025-12-02",
    "quarterlyGoal": "...",
    "improvements": "...",
    "happyMoments": "...",
    "futureTasks": "...",
    "activities": [...],
    "createdAt": "2025-12-02T10:00:00Z",
    "updatedAt": "2025-12-02T10:00:00Z"
  }
]
```

#### POST /api/reports
日報作成

**リクエスト**:
```json
{
  "date": "2025-12-02",
  "quarterlyGoal": "...",
  "improvements": "...",
  "happyMoments": "...",
  "futureTasks": "...",
  "activities": [
    {
      "projectCategory": "プロジェクトA",
      "content": "...",
      "workingHours": 5.5,
      "issues": "...",
      "order": 0
    }
  ]
}
```

**レスポンス**: 作成された日報オブジェクト

#### GET /api/reports/[id]
日報詳細取得（自分の日報のみ）

**レスポンス**: 日報オブジェクト

#### PUT /api/reports/[id]
日報更新（自分の日報のみ）

**リクエスト**: POST /api/reportsと同じ

**レスポンス**: 更新された日報オブジェクト

#### DELETE /api/reports/[id]
日報削除（自分の日報のみ）

**レスポンス**:
```json
{
  "message": "削除成功"
}
```

### 5.3 管理者API

#### GET /api/admin/users
全社員リスト取得（管理者のみ）

**レスポンス**:
```json
[
  {
    "id": "uuid",
    "employeeNumber": "EMP001",
    "employeeName": "山田太郎",
    "role": "USER",
    "createdAt": "2025-12-01T00:00:00Z",
    "_count": {
      "reports": 10
    }
  }
]
```

#### GET /api/admin/reports
全社員の日報取得（管理者のみ）

**クエリパラメータ**:
- `userId`: ユーザーIDで絞り込み
- `employeeNumber`: 社員番号で絞り込み
- `startDate`: 開始日
- `endDate`: 終了日

**レスポンス**:
```json
[
  {
    "id": "uuid",
    "date": "2025-12-02",
    "quarterlyGoal": "...",
    "improvements": "...",
    "happyMoments": "...",
    "futureTasks": "...",
    "activities": [...],
    "user": {
      "id": "uuid",
      "employeeNumber": "EMP001",
      "employeeName": "山田太郎"
    },
    "createdAt": "2025-12-02T10:00:00Z",
    "updatedAt": "2025-12-02T10:00:00Z"
  }
]
```

#### PATCH /api/admin/users/[id]/role
社員権限変更（管理者のみ）

**リクエスト**:
```json
{
  "role": "ADMIN"
}
```

**レスポンス**: 更新されたユーザーオブジェクト

#### POST /api/admin/log
操作ログ記録（管理者のみ）

**リクエスト**:
```json
{
  "actionType": "LOGIN",
  "targetUserId": "uuid",
  "targetReportId": "uuid",
  "details": "管理画面にログイン"
}
```

**レスポンス**:
```json
{
  "success": true,
  "log": {...}
}
```

#### GET /api/admin/log
操作ログ取得（管理者のみ）

**クエリパラメータ**:
- `adminId`: 管理者IDで絞り込み
- `actionType`: 操作タイプで絞り込み
- `limit`: 取得件数（デフォルト: 100）
- `offset`: オフセット（デフォルト: 0）

**レスポンス**:
```json
[
  {
    "id": "uuid",
    "actionType": "LOGIN",
    "targetUserId": null,
    "targetReportId": null,
    "details": "管理画面にログイン",
    "ipAddress": "192.168.1.1",
    "createdAt": "2025-12-02T10:00:00Z",
    "admin": {
      "id": "uuid",
      "employeeNumber": "ADMIN001",
      "employeeName": "管理者",
      "role": "ADMIN"
    }
  }
]
```

## 6. 画面遷移図

```
┌──────────────┐
│ /login       │ ログイン画面（一般）
└──────┬───────┘
       │ ログイン成功
       ↓
┌──────────────┐
│ /            │ ホーム（日報一覧）
└──┬───────┬───┘
   │       │
   │       └─→ ┌──────────────┐
   │           │ /reports/new │ 新規作成
   │           └──────────────┘
   │
   └─→ ┌────────────────┐
       │ /reports/[id]  │ 詳細
       └────────────────┘


┌──────────────────┐
│ /admin/login     │ 管理者ログイン
└────────┬─────────┘
         │ ログイン成功（管理者のみ）
         ↓
┌──────────────────┐
│ /admin           │ 管理者ダッシュボード
└──┬───────┬───┬───┘
   │       │   │
   │       │   └─→ ┌───────────────────┐
   │       │       │ /admin/reports/[id]│ 日報詳細
   │       │       └───────────────────┘
   │       │
   │       └─→ ┌──────────────┐
   │           │ /admin/users │ 社員管理
   │           └──────────────┘
   │
   └─→ ┌──────────────┐
       │ /admin/logs  │ 操作ログ
       └──────────────┘
```

## 7. 技術スタック

### 7.1 フロントエンド
- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 18
- **スタイリング**: Tailwind CSS
- **状態管理**: React Context API

### 7.2 バックエンド
- **フレームワーク**: Next.js API Routes
- **言語**: TypeScript
- **ORM**: Prisma 7
- **認証**: JWT (jsonwebtoken)
- **パスワードハッシュ**: bcryptjs

### 7.3 データベース
- **DBMS**: PostgreSQL
- **ホスティング**: Supabase

### 7.4 デプロイ
- **ホスティング**: Vercel

## 8. 開発スケジュール（参考）

### フェーズ1: 基本機能（完了）
- ✅ プロジェクトセットアップ
- ✅ データベース設計
- ✅ 認証機能実装
- ✅ 日報CRUD機能実装
- ✅ 動的活動セクション実装

### フェーズ2: 管理機能（完了）
- ✅ 管理者権限追加
- ✅ 管理画面実装
- ✅ 社員管理機能実装
- ✅ 操作ログ機能実装
- ✅ ドキュメント作成

### フェーズ3: デプロイ・運用（予定）
- ⏳ Vercelへのデプロイ
- ⏳ 本番環境での動作確認
- ⏳ ユーザーテスト
- ⏳ フィードバック対応

## 9. 運用・保守

### 9.1 バックアップ
- Supabaseの自動バックアップ機能を使用
- 定期的なデータエクスポート

### 9.2 監視
- Vercelのアナリティクス機能でパフォーマンス監視
- エラーログの定期確認

### 9.3 セキュリティ更新
- 依存パッケージの定期的な更新
- セキュリティ脆弱性のチェック

### 9.4 ユーザーサポート
- 操作マニュアルの整備
- 問い合わせ窓口の設置

## 10. 制限事項・今後の課題

### 10.1 現状の制限事項
- モバイルアプリは未実装（Webのみ）
- 日報の検索機能なし
- 日報のPDF出力機能なし
- 通知機能なし
- ファイル添付機能なし

### 10.2 今後の拡張案
- モバイルアプリ（React Native）の実装
- 日報の全文検索機能
- PDF/Excel出力機能
- メール通知機能（日報未提出時など）
- グラフ・統計機能の強化
- ファイル添付機能
- コメント・フィードバック機能
- 承認フロー機能

## 11. 変更履歴

| バージョン | 日付       | 変更内容                           |
|-----------|------------|------------------------------------|
| 1.0       | 2025-12-02 | 初版作成（基本機能）                |
| 2.0       | 2025-12-02 | 管理機能追加（権限管理、操作ログ） |
| 2.1       | 2025-12-04 | 日報機能の改善（本日の目標、時刻入力、編集機能） |
